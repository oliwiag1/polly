name: Backend CI/CD - ACR Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  IMAGE_NAME: polly-backend
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================
  # JOB 1: Lint & Code Quality
  # ============================================
  lint:
    name: ğŸ” Lint & Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: ğŸ“¦ Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: ğŸ” Run Ruff linter
        run: ruff check app/ --output-format=github

      - name: ğŸ” Run Ruff formatter check
        run: ruff format app/ --check

      - name: ğŸ” Run MyPy type checking
        run: mypy app/ --ignore-missing-imports --no-error-summary || true

  # ============================================
  # JOB 2: Unit & Integration Tests
  # ============================================
  test:
    name: ğŸ§ª Test Backend
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      lines_pct: ${{ steps.coverage.outputs.lines_pct }}
    defaults:
      run:
        working-directory: backend

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ§ª Run tests with coverage
        id: coverage
        run: |
          pytest --cov=app --cov-report=term-missing --cov-report=xml --cov-report=html --cov-fail-under=90
          python - << 'PY'
          import xml.etree.ElementTree as ET
          root = ET.parse('coverage.xml').getroot()
          rate = float(root.attrib.get('line-rate', '0'))
          pct = rate * 100
          print(f"lines_pct={pct:.2f}")
          PY
          python - << 'PY' >> "$GITHUB_OUTPUT"
          import xml.etree.ElementTree as ET
          root = ET.parse('coverage.xml').getroot()
          rate = float(root.attrib.get('line-rate', '0'))
          pct = rate * 100
          print(f"lines_pct={pct:.2f}")
          PY

      - name: ğŸ“Š Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: |
            backend/coverage.xml
            backend/htmlcov/
          retention-days: 7

  # ============================================
  # JOB 3: Security Scan
  # ============================================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: lint
    defaults:
      run:
        working-directory: backend

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: ğŸ”’ Run Bandit security linter
        run: bandit -r app/ -f json -o bandit-report.json || true

      - name: ğŸ”’ Check dependencies for vulnerabilities
        run: safety check -r requirements.txt --output json > safety-report.json || true

      - name: ğŸ“¤ Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            backend/bandit-report.json
            backend/safety-report.json
          retention-days: 7

  # ============================================
  # JOB 4: Build and Push to ACR
  # ============================================
  build-and-push:
    name: ğŸ³ Build and Push to ACR
    runs-on: ubuntu-latest
    needs: [test, security]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: ğŸ³ Build and push image
        run: |
          cd backend
          docker build -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest .
          docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

  # ============================================
  # JOB 5: Pipeline Summary
  # ============================================
  summary:
    name: ğŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [lint, test, security, build-and-push]
    if: always()

    steps:
      - name: ğŸ“‹ Generate summary
        run: |
          echo "## ğŸš€ Backend Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Lint & Code Quality | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Backend Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š Coverage (Lines) | ${{ needs.test.outputs.lines_pct }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”’ Security Scan | ${{ needs.security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ³ Build & Push (ACR) | ${{ needs.build-and-push.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
